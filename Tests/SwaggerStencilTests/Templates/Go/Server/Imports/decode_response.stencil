{% macro setupResponse responseName response %}
{% set hasSchema %}{{ response|hasSchema }}{% endset %}
{% if hasSchema %}
{% set isPrimitive %}{{ response|responseIsPrimitive }}{% endset %}
{% set typeName %}{{ response|responseSchemaType:"golang" }}{% endset %}
{% if isPrimitive %}
    var {{ responseName }} {{ typeName }}
{% else %}
    {{ responseName }} := {{ typeName }}{}
{% endif %}
{% else %}
    {{ responseName }} := models.Empty{}
{% endif %}
{% endmacro %}

{% macro setupDefaultResponse operation %}
{% if operation.defaultResponse %}
{% set responseName %}defaultResponse{% endset %}
{% call setupResponse responseName operation.defaultResponse %}
{% endif %}
{% endmacro %}

{% macro setupResponses operation %}
{% for code,response in operation.responses %}
{% set responseName %}response{{ code }}{% endset %}
{% call setupResponse responseName response %}
{% endfor %}
{% endmacro %}

{% macro decodeResponseHelper3 variableName schema %}
{% if schema.type.string %}
        var buf bytes.Buffer
        buf.ReadFrom(response.Body)
        {{ variableName }} = buf.String()
{% elif schema.type.structure or schema.type.array %}
        err = decoder.Decode(&{{ variableName }})
{% endif %}
{% endmacro %}

{% macro decodeResponseHelper2 variableName response %}
{% if response.schema.some %}
{% call decodeResponseHelper3 variableName response.schema %}
{% else %}
        break
{% endif %}
{% endmacro %}

{% macro decodeResponseHelper variableName either %}
{% if either.a %}
{% call decodeResponseHelper2 variableName either.a %}
{% else %}
{% call decodeResponseHelper2 variableName either.b.structure %}
{% endif %}
{% endmacro %}

{% macro decodeResponse operation %}
    // Decode the response:
    decoder := json.NewDecoder(response.Body)
    switch response.StatusCode {
{% for code,response in operation.responses %}
{% set variableName %}response{{ code }}{% endset %}
    case {{ code }}:
{% call decodeResponseHelper variableName response %}
{% endfor %}
    default:
{% if operation.defaultResponse %}
        err = decoder.Decode(&defaultResponse)
{% else %}
        break
{% endif %}
    }

{% call encodeError operation %}
{% endmacro %}
